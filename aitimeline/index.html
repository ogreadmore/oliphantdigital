<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Timeline Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<style>
:root{
 /* COLORS */
 --bg:#18181b;--fg:#e4e4e7;
 --accent:#c026d3;--accent-light:#d946ef;
 --card-bg:#27272a;--scrollbar:#3f3f46;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* ------------------ HEADER ------------------------------------------------ */
header{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1.1rem;background:#000a;backdrop-filter:blur(8px)}
header h1{font-size:1rem;letter-spacing:.02em;font-weight:600;white-space:nowrap}
nav,nav>*{display:flex;gap:.5rem;align-items:center}
button{cursor:pointer;border:none;border-radius:7px;padding:.45rem .9rem;font-size:.8rem;background:#3f3f46;color:var(--fg);transition:.2s}
button.active,button:hover{background:var(--accent)}
/* ------------------ MAIN CONTAINERS -------------------------------------- */
main{flex:1;position:relative}
.view{position:absolute;inset:0;overflow:hidden}
#timelineWrap{overflow:auto;cursor:grab}
#timelineWrap:active{cursor:grabbing}
#dashWrap{display:none;overflow:auto;padding:1rem}

/* ------------------ SCROLLBAR CUSTOM ------------------------------------- */
#timelineWrap::-webkit-scrollbar{height:13px}
#timelineWrap::-webkit-scrollbar-track{background:#1e1e23}
#timelineWrap::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:6px}
#timelineWrap:hover::-webkit-scrollbar-thumb{background:var(--accent)}

/* ------------------ SVG ELEMENTS ----------------------------------------- */
.tick-line{stroke:#2d2d32;stroke-width:1}
.tick-text{fill:var(--fg);font-size:.74rem;font-weight:400;text-anchor:middle}
.job-rect{rx:6;ry:6;fill:var(--accent);transition:fill .15s}
.job-text{fill:#fff;font-size:.65rem;font-weight:600;pointer-events:none}
/* MOBILE vertical orientation overrides will be injected via JS */

/* ------------------ DASHBOARD TABLE -------------------------------------- */
table{width:100%;border-collapse:collapse;min-width:620px}
thead th{position:sticky;top:0;background:#000c;padding:.65rem;font-size:.75rem;text-align:left;color:var(--accent-light);backdrop-filter:blur(6px)}
tbody td{padding:.55rem .65rem;font-size:.72rem;border-bottom:1px solid #2f2f33}
tbody tr:hover{background:#222225}

/* ------------------ TOOLTIP ----------------------------------------------*/
#tooltip{position:fixed;pointer-events:none;visibility:hidden;background:#000d;padding:.55rem .75rem;border-radius:6px;font-size:.75rem;color:var(--fg);max-width:230px;line-height:1.3}
#tooltip h4{margin:0 0 .2rem;font-size:.78rem;color:var(--accent-light)}
#tooltip p{margin:.12rem 0}

/* ------------------ MODALS ------------------------------------------------*/
.modal-overlay{position:fixed;inset:0;background:#000c;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:30;visibility:hidden;opacity:0;transition:.2s}
.modal{background:#26262b;color:var(--fg);padding:1rem 1.2rem;border-radius:8px;max-width:320px;width:90%;font-size:.82rem}
.modal h3{margin:0 0 .5rem;font-size:.9rem;color:var(--accent-light)}
.modal p{margin:.25rem 0}
.modal-close{margin-top:.8rem;text-align:right}
.modal-close button{background:#3f3f46}
/* show state */
.modal-overlay.show{visibility:visible;opacity:1}

/* ------------------ MEDIA QUERIES ---------------------------------------- */
@media(max-width:850px){
  header h1{font-size:.9rem}
  button{font-size:.75rem;padding:.4rem .8rem}
  .job-text{font-size:.6rem}
}
@media(max-width:600px){
  header{padding:.6rem .7rem}
  button{font-size:.72rem;padding:.35rem .7rem}
}
</style>
</head>

<body>

<header>
  <h1>AI Timeline Demo</h1>
  <nav>
    <button id="btnTimeline" class="active">Timeline</button>
    <button id="btnDash">Current %</button>
    <button id="btnAbout">About</button>
  </nav>
</header>

<main>
  <div id="timelineWrap" class="view"><svg id="timelineSVG"></svg></div>
  <div id="dashWrap"  class="view">
    <table id="dashTbl"><thead><tr>
      <th>Job</th><th>AI % Now</th><th>AI&nbsp;+&nbsp;Auto % Now</th><th>Industry</th><th>Full-Auto&nbsp;Year</th>
    </tr></thead><tbody></tbody></table>
  </div>
</main>

<!-- Tooltip -->
<div id="tooltip"></div>

<!-- Universal modal overlay (job details & about) -->
<div id="modalOverlay" class="modal-overlay">
  <div id="modalBox" class="modal"></div>
</div>

<script>
/* CONFIG ------------------------------------------------------------*/
const CARD_H = 24, CARD_W = 140, GAP = 10, TOP_PAD = 50;
const YEAR_PIXELS = 110;          // px per year (desktop horiz) OR px per year (mobile vertical)
const MOBILE_BREAK = 650;
let jobs = [], isMobile=false;

/* ENTRY -------------------------------------------------------------*/
fetch('jobs.json').then(r=>r.json())
  .then(j=>{ jobs=Object.values(j).flat(); init(); })
  .catch(e=>console.error('jobs.json missing',e));

function init(){
  isMobile = window.innerWidth < MOBILE_BREAK;
  buildTimeline(); buildDash();
  initNav(); initModal();
  window.addEventListener('resize', debounce(()=>location.reload(),300));
}

/* TIMELINE ----------------------------------------------------------*/
function buildTimeline(){
  const svg = d3.select('#timelineSVG'); svg.selectAll('*').remove();
  const years=jobs.map(j=>j.ai_plus_full_year??j.ai_only_full_year).filter(Boolean);
  const minY=Math.min(...years), maxY=Math.max(...years);
  /* scales */
  const span=maxY-minY;
  if(isMobile) buildVertical(svg,minY,maxY,span); else buildHorizontal(svg,minY,maxY,span);
}

/* ---------- horizontal (desktop) */
function buildHorizontal(svg,minY,maxY,span){
  const x = d3.scaleLinear().domain([minY,maxY]).range([50, span*YEAR_PIXELS+50]);
  const buckets={};
  jobs.forEach(j=>{
    const y=j.ai_plus_full_year??j.ai_only_full_year;
    if(!buckets[y]) buckets[y]=[]; buckets[y].push(j);
  });
  const maxStack = Math.max(...Object.values(buckets).map(b=>b.length));
  const h = TOP_PAD + maxStack*(CARD_H+GAP) + 80;
  const w = x(maxY)+CARD_W+70;
  svg.attr('height',h).attr('width',w);

  // year grid
  svg.append('g')
     .selectAll('g')
     .data(d3.range(minY,maxY+1))
     .enter().append('g')
     .attr('transform',d=>`translate(${x(d)},0)`)
     .call(g=>{
        g.append('line').attr('class','tick-line').attr('y1',0).attr('y2',h);
        g.append('text').attr('class','tick-text').attr('y',15).text(d=>d)
     });

  // cards
  Object.entries(buckets).forEach(([yr,list])=>{
    list.forEach((j,idx)=>{
      const gx = x(+yr)-CARD_W/2, gy = TOP_PAD + idx*(CARD_H+GAP);
      const g=svg.append('g').attr('transform',`translate(${gx},${gy})`).attr('data-job',j.job_code);
      g.append('rect').attr('class','job-rect').attr('width',CARD_W).attr('height',CARD_H);
      g.append('text').attr('class','job-text')
        .attr('x',CARD_W/2).attr('y',CARD_H/2+4)
        .attr('text-anchor','middle').text(truncate(j.job_title,22));
    });
  });
  attachCardEvents();
  enableDragScroll();
}

/* ---------- vertical (mobile) */
function buildVertical(svg,minY,maxY,span){
  const y = d3.scaleLinear().domain([minY,maxY]).range([50,span*YEAR_PIXELS+50]);
  const buckets={};
  jobs.forEach(j=>{
    const yr=j.ai_plus_full_year??j.ai_only_full_year;
    if(!buckets[yr]) buckets[yr]=[]; buckets[yr].push(j);
  });
  const maxStack=Math.max(...Object.values(buckets).map(b=>b.length));
  const w =  TOP_PAD + maxStack*(CARD_H+GAP) + 80;
  const h = y(maxY)+CARD_W+70;
  svg.attr('height',h).attr('width',w);

  // year grid
  svg.append('g')
     .selectAll('g')
     .data(d3.range(minY,maxY+1))
     .enter().append('g')
       .attr('transform',d=>`translate(0,${y(d)})`)
     .call(g=>{
        g.append('line').attr('class','tick-line').attr('x1',0).attr('x2',w);
        g.append('text').attr('class','tick-text').attr('x',15).attr('dy',4).text(d=>d);
     });

  // cards
  Object.entries(buckets).forEach(([yr,list])=>{
    list.forEach((j,idx)=>{
      const gy = y(+yr)-CARD_W/2, gx = TOP_PAD + idx*(CARD_H+GAP);
      const g=svg.append('g').attr('transform',`translate(${gx},${gy}) rotate(90)`).attr('data-job',j.job_code);
      g.append('rect').attr('class','job-rect').attr('width',CARD_W).attr('height',CARD_H);
      g.append('text').attr('class','job-text')
        .attr('x',CARD_W/2).attr('y',CARD_H/2+4)
        .attr('text-anchor','middle').text(truncate(j.job_title,22));
    });
  });
  attachCardEvents();
  enableDragScroll();
}

/* CARD EVENTS (hover + click) --------------------------------------*/
function attachCardEvents(){
  const tip = document.getElementById('tooltip');
  d3.selectAll('g[data-job]')
    .on('mousemove',function(e){
       if(isMobile) return;
       const job = findJob(this.dataset.job);
       tip.innerHTML = `<h4>${job.job_title}</h4>
        <p>AI&nbsp;%&nbsp;Now: ${job.ai_pct_now ?? '—'}%</p>
        <p>AI+Auto&nbsp;%&nbsp;Now: ${job.ai_plus_pct_now ?? '—'}%</p>
        <p>Full&nbsp;Auto&nbsp;Year: ${(job.ai_plus_full_year ?? job.ai_only_full_year) || '—'}</p>`;
       const {clientX:x,clientY:y}=e;
       tip.style.left=`${x+15}px`; tip.style.top=`${y+15}px`;
       tip.style.visibility='visible';
    })
    .on('mouseleave',()=>{ if(!isMobile) tip.style.visibility='hidden'; })
    .on('click',function(){
       const job=findJob(this.dataset.job);
       showModal(`<h3>${job.job_title}</h3>
        <p><b>Industry:</b> ${job.industry}</p>
        <p><b>AI % Now:</b> ${job.ai_pct_now ?? '—'}%</p>
        <p><b>AI + Automation % Now:</b> ${job.ai_plus_pct_now ?? '—'}%</p>
        <p><b>Full Automation Year:</b> ${(job.ai_plus_full_year ?? job.ai_only_full_year) || '—'}</p>
        <p><b>Upskill:</b> ${(job.upskill_suggestions||'').split('|').join(', ')}</p>`);
    });
}

function findJob(code){return jobs.find(j=>j.job_code===code);}
function truncate(str,len){return str.length>len?str.slice(0,len-1)+'…':str;}

/* DASHBOARD ---------------------------------------------------------*/
function buildDash(){
  const tbody=d3.select('#dashTbl tbody');
  jobs.forEach(j=>{
    const yr=j.ai_plus_full_year??j.ai_only_full_year??'—';
    tbody.append('tr').html(`
      <td>${j.job_title}</td>
      <td>${j.ai_pct_now ?? '—'}%</td>
      <td>${j.ai_plus_pct_now ?? '—'}%</td>
      <td>${j.industry}</td>
      <td>${yr}</td>
    `);
  });
}

/* DRAG-SCROLL + CTRL-ZOOM ------------------------------------------*/
function enableDragScroll(){
  const wrap=document.getElementById('timelineWrap');
  let isDown=false,startX,startY,scrollL,scrollT;
  wrap.addEventListener('mousedown',e=>{isDown=true;startX=e.pageX;startY=e.pageY;scrollL=wrap.scrollLeft;scrollT=wrap.scrollTop;});
  wrap.addEventListener('mousemove',e=>{
    if(!isDown)return;
    wrap.scrollLeft = scrollL - (e.pageX-startX);
    wrap.scrollTop  = scrollT - (e.pageY-startY);
  });
  document.addEventListener('mouseup',()=>isDown=false);

  /* smooth zoom only when ctrlKey pressed (avoids accidental) */
  wrap.addEventListener('wheel',e=>{
     if(!e.ctrlKey) return;
     e.preventDefault();
     const scale=(e.deltaY<0)?1.1:0.9;
     wrap.querySelector('svg').style.transformOrigin='0 0';
     const cur = wrap._zoom||1;
     const next = Math.max(.5,Math.min(3,cur*scale));
     wrap._zoom=next;
     wrap.querySelector('svg').style.transform=`scale(${next})`;
  },{passive:false});
}

/* NAVIGATION & MODAL -----------------------------------------------*/
function initNav(){
  const btnT=document.getElementById('btnTimeline');
  const btnD=document.getElementById('btnDash');
  const tw=document.getElementById('timelineWrap');
  const dw=document.getElementById('dashWrap');
  btnT.onclick=()=>{btnT.classList.add('active');btnD.classList.remove('active');tw.style.display='block';dw.style.display='none';};
  btnD.onclick=()=>{btnD.classList.add('active');btnT.classList.remove('active');dw.style.display='block';tw.style.display='none';};
  document.getElementById('btnAbout').onclick=showAbout;
}

function initModal(){
  const ov=document.getElementById('modalOverlay');
  ov.addEventListener('click',e=>{if(e.target===ov)hideModal();});
}
function showModal(html){
  const box=document.getElementById('modalBox');
  box.innerHTML=html+`<div class="modal-close"><button onclick="hideModal()">Close</button></div>`;
  document.getElementById('modalOverlay').classList.add('show');
}
function hideModal(){document.getElementById('modalOverlay').classList.remove('show');}
function showAbout(){
  showModal(`<h3>About AITimeline</h3>
    <p><b>AITimeline.net</b> visualises expert forecasts on when AI (alone or with complementary automation) will be able to perform specific jobs.</p>
    <p>Hover (desktop) or tap (mobile) any job card for details. Data sources include WEF 2023, McKinsey 2023, Stanford AI Index 2024, and peer-reviewed studies (2019-2025).</p>
    <p>Built by <em>Oliphant Digital</em> • v0.1 demo</p>`);
}

/* UTIL --------------------------------------------------------------*/
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}}
</script>
</body>
</html>
